#!/bin/bash

# Git post-receive hook
# 当代码推送到服务器时自动触发部署

set -e

# 配置变量
PROJECT_DIR="/path/to/your/project"  # 修改为您的项目路径
DEPLOY_SCRIPT="$PROJECT_DIR/scripts/deploy.sh"
LOG_FILE="/var/log/git-hook.log"

# 日志函数
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "Git hook 触发"

# 读取推送的分支信息
while read oldrev newrev refname; do
    branch=$(echo "$refname" | sed 's|refs/heads/||')
    
    log "检测到分支推送: $branch"
    
    # 只对main分支进行自动部署
    if [ "$branch" = "main" ]; then
        log "开始自动部署..."
        
        # 执行部署脚本
        if [ -f "$DEPLOY_SCRIPT" ]; then
            cd "$PROJECT_DIR"
            bash "$DEPLOY_SCRIPT" "$branch"
            log "部署完成"
        else
            log "错误: 部署脚本不存在: $DEPLOY_SCRIPT"
            exit 1
        fi
    else
        log "跳过分支 $branch 的自动部署"
    fi
done

log "Git hook 执行完成"
