# 用户API测试指南

## 概述
本指南提供了完整的用户API测试方案，包括Postman集合、测试数据和自动化测试脚本。

## 文件结构
```
├── postman/
│   ├── User_API_Collection.json    # Postman集合文件
│   └── User_API_Environment.json   # Postman环境配置
├── test_data/
│   ├── generate_test_users.sql     # 测试数据生成脚本
│   └── api_test_script.sh          # API测试脚本
├── docs/
│   └── API_Documentation.md        # 详细API文档
└── README_TESTING.md               # 本文件
```

## 快速开始

### 1. 环境准备
确保以下环境已准备就绪：
- 服务器已启动（默认端口3000）
- 数据库已配置并运行
- 已执行数据库迁移脚本

### 2. 导入Postman集合
1. 打开Postman
2. 点击"Import"按钮
3. 导入 `postman/User_API_Collection.json`
4. 导入 `postman/User_API_Environment.json`

### 3. 设置环境变量
在Postman中设置以下环境变量：
- `base_url`: `http://localhost:3000`
- `turnstile_token`: `test_token`
- `access_token`: （登录后自动设置）
- `user_id`: （登录后自动设置）

### 4. 生成测试数据
执行数据库脚本生成测试数据：
```sql
-- 在数据库中执行
source test_data/generate_test_users.sql;
```

### 5. 开始测试
按以下顺序执行API测试：

#### 基础功能测试
1. **发送手机验证码** - 获取验证码
2. **用户注册** - 创建新用户
3. **用户登录** - 获取访问令牌
4. **获取用户信息** - 验证登录状态

#### 高级功能测试
5. **更新用户信息** - 修改个人信息
6. **修改密码** - 更改密码
7. **生成访问令牌** - 获取新令牌
8. **获取邀请码** - 查看邀请码

#### 密码重置测试
9. **发送密码重置验证码** - 获取重置验证码
10. **重置密码** - 重置用户密码
11. **使用新密码登录** - 验证重置结果

#### 清理测试
12. **用户登出** - 清除会话
13. **删除用户账户** - 清理测试数据

## 测试数据说明

### 预置测试用户
系统会生成以下测试用户：

| 手机号 | 用户名 | 显示名称 | 角色 | 状态 |
|--------|--------|----------|------|------|
| 13800138001 | user_8001 | 张三 | 普通用户 | 启用 |
| 13800138002 | user_8002 | 李四 | 普通用户 | 启用 |
| 13800138003 | user_8003 | 王五 | 普通用户 | 启用 |
| 13800138004 | user_8004 | 赵六 | 普通用户 | 启用 |
| 13800138005 | user_8005 | 钱七 | 普通用户 | 启用 |
| 13800138006 | admin_001 | 管理员A | 管理员 | 启用 |
| 13800138007 | admin_002 | 管理员B | 管理员 | 启用 |
| 13800138008 | root_admin | 超级管理员 | 超级管理员 | 启用 |
| 13800138009 | disabled_user | 禁用用户 | 普通用户 | 禁用 |
| 13800138010 | vip_user | VIP用户 | 普通用户 | 启用 |

### 测试令牌
每个用户都会生成对应的测试令牌：
- `sk-test-token-001` 到 `sk-test-token-005`

### 验证码
- 手机验证码: `1111`
- 密码重置验证码: `1111`

## 自动化测试

### 使用Shell脚本测试
```bash
# 给脚本执行权限
chmod +x test_data/api_test_script.sh

# 执行测试
./test_data/api_test_script.sh
```

### 脚本功能
- 自动测试所有主要API接口
- 显示测试结果和错误信息
- 支持彩色输出
- 包含详细的错误处理

## 常见问题

### 1. 连接错误
**问题**: 无法连接到服务器
**解决**: 
- 检查服务器是否启动
- 确认端口号是否正确
- 检查防火墙设置

### 2. 数据库错误
**问题**: 数据库连接失败
**解决**:
- 检查数据库配置
- 确认数据库服务运行状态
- 验证数据库权限

### 3. 认证错误
**问题**: 401未授权错误
**解决**:
- 确认已正确登录
- 检查访问令牌是否有效
- 验证用户ID是否正确

### 4. 验证码错误
**问题**: 验证码无效
**解决**:
- 确认使用正确的验证码（1111）
- 检查验证码是否过期
- 重新发送验证码

### 5. 手机号已存在
**问题**: 注册时提示手机号已存在
**解决**:
- 使用不同的手机号
- 清理测试数据
- 检查数据库中的重复记录

## 测试最佳实践

### 1. 测试顺序
- 按照文档中的顺序执行测试
- 确保每个测试都基于前一个测试的结果
- 不要跳过依赖步骤

### 2. 数据清理
- 测试完成后清理测试数据
- 避免测试数据影响生产环境
- 定期清理过期的测试数据

### 3. 错误处理
- 记录所有错误信息
- 分析错误原因
- 及时修复发现的问题

### 4. 性能测试
- 测试API响应时间
- 检查并发处理能力
- 验证系统稳定性

## 扩展测试

### 1. 边界值测试
- 测试手机号格式边界
- 测试密码长度限制
- 测试验证码有效期

### 2. 异常情况测试
- 测试无效的请求参数
- 测试重复注册
- 测试并发登录

### 3. 安全性测试
- 测试SQL注入防护
- 测试XSS攻击防护
- 测试CSRF攻击防护

## 联系支持

如果在测试过程中遇到问题，请：
1. 查看错误日志
2. 检查系统配置
3. 参考API文档
4. 联系技术支持

## 更新日志

### v1.0.0 (2024-01-01)
- 初始版本发布
- 包含完整的用户API测试套件
- 支持Postman和Shell脚本测试
- 提供详细的测试文档
