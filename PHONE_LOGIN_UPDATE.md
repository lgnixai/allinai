# 手机号登录系统更新说明

## 概述
本次更新将系统的登录、注册方式从用户名/邮箱改为只允许手机号登录，以提供更统一的用户认证体验。

## 主要变更

### 1. 登录方式变更
- **原方式**: 支持用户名或邮箱登录
- **新方式**: 仅支持手机号登录
- **API变更**: `POST /api/user/login` 请求参数从 `username` 改为 `phone`

### 2. 注册方式变更
- **原方式**: 支持用户名和邮箱注册
- **新方式**: 仅支持手机号注册，手机号验证码必填
- **用户名生成**: 系统自动生成用户名（格式：`user_手机号后4位`）
- **显示名称**: 用户可自定义显示名称

### 3. 忘记密码功能变更
- **原方式**: 通过邮箱发送重置链接
- **新方式**: 通过手机号发送验证码
- **API变更**: `GET /api/reset_password` 参数从 `email` 改为 `phone`

## 数据库变更

### 1. 手机号字段约束
- 手机号字段设置为非空（NOT NULL）
- 添加唯一索引，确保手机号唯一性
- 验证规则：11位数字

### 2. 迁移文件
- `bin/migration_v0.4-v0.5.sql`: 添加新字段
- `bin/migration_v0.5-v0.6.sql`: 更新字段约束

## API接口变更

### 登录接口
```json
// 原请求
{
  "username": "用户名或邮箱",
  "password": "密码"
}

// 新请求
{
  "phone": "手机号",
  "password": "密码"
}
```

### 注册接口
```json
// 新请求格式
{
  "phone": "手机号",
  "phone_verification_code": "手机验证码",
  "password": "密码",
  "display_name": "显示名称",
  "school": "学校",
  "college": "学院"
}
```

### 忘记密码接口
```json
// 发送验证码
GET /api/reset_password?phone=手机号

// 重置密码
POST /api/user/reset
{
  "phone": "手机号",
  "token": "验证码"
}
```

## 功能特性

### 1. 手机号验证
- 支持手机号格式验证（11位数字）
- 手机号唯一性检查
- 验证码有效期：10分钟

### 2. 用户信息管理
- 用户名自动生成，不可修改
- 显示名称可自定义
- 支持学校、学院信息填写

### 3. 安全性
- 手机号验证码必填
- 密码重置需要验证码验证
- 保持现有的密码加密和会话管理

## 向后兼容性

### 1. 现有用户
- 现有用户需要绑定手机号才能继续使用
- 用户名和邮箱字段保留，但不再用于登录
- 建议提供手机号绑定功能

### 2. 数据迁移
- 需要为现有用户添加手机号
- 可能需要清理重复的手机号记录

## 前端更新建议

### 1. 登录页面
- 将用户名/邮箱输入框改为手机号输入框
- 添加手机号格式验证
- 更新错误提示信息

### 2. 注册页面
- 添加手机号输入框
- 添加手机号验证码输入框和发送按钮
- 移除用户名输入框
- 添加显示名称输入框

### 3. 忘记密码页面
- 将邮箱输入框改为手机号输入框
- 更新验证码发送逻辑
- 更新密码重置流程

### 4. 个人设置页面
- 显示自动生成的用户名（只读）
- 允许修改显示名称
- 支持学校、学院信息编辑

## 测试建议

### 1. 功能测试
- 手机号注册流程
- 手机号登录流程
- 手机号验证码发送
- 密码重置流程
- 用户信息更新

### 2. 数据验证测试
- 手机号格式验证
- 手机号唯一性检查
- 验证码有效期测试
- 错误处理测试

### 3. 兼容性测试
- 现有用户数据迁移
- 第三方登录功能
- API接口兼容性

## 注意事项

1. **生产环境部署**: 需要集成真实的短信服务
2. **数据迁移**: 需要为现有用户添加手机号
3. **用户体验**: 提供清晰的手机号绑定引导
4. **错误处理**: 完善手机号相关的错误提示
5. **安全性**: 确保手机号验证的安全性

## 后续优化

1. 集成短信服务提供商
2. 添加手机号登录日志
3. 实现手机号登录限制
4. 添加手机号变更功能
5. 优化用户体验流程
